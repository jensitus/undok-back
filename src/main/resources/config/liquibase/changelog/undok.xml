<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

<changeSet id="create_tasks" author="jensitus">
    <createTable tableName="tasks">
        <column name="id" type="UUID">
            <constraints primaryKey="true" />
        </column>
        <column name="title" type="varchar(255)" />
        <column name="description" type="varchar(1024)" />
        <column name="due_date" type="date" />
        <column name="required_time" type="int" />
        <column name="status" type="varchar(64)" />
        <column name="case_id" type="uuid" />
        <column name="created_at" type="timestamp" />
        <column name="created_by" type="varchar(255)" />
        <column name="updated_at" type="timestamp" />
    </createTable>
</changeSet>

    <changeSet id="add-full-text-index" author="jensitus">
        <sql>
            ALTER TABLE counselings
                ADD COLUMN search_vector tsvector
                    GENERATED ALWAYS AS (
                        setweight(to_tsvector('german', COALESCE(concern, '')), 'A') ||
                        setweight(to_tsvector('german', COALESCE(activity, '')), 'B')
                        ) STORED
        </sql>

        <sql>
            CREATE INDEX counselings_search_idx ON counselings USING GIN (search_vector)
        </sql>

        <rollback>
            DROP INDEX IF EXISTS counselings_search_idx;
            ALTER TABLE counselings DROP COLUMN search_vector;
        </rollback>
    </changeSet>

</databaseChangeLog>